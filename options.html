<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>Playlist Export Configuration</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      background-color: #f5f5f5;
    }
    
    .section {
      background-color: white;
      padding: 15px;
      margin-bottom: 15px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    h2 {
      margin-top: 0;
      color: #333;
      font-size: 18px;
    }
    
    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
      color: #555;
    }
    
    input[type="text"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ddd;
      border-radius: 3px;
      box-sizing: border-box;
      margin-bottom: 10px;
    }
    
    .path-input-group {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }
    
    .path-input-group input[type="text"] {
      flex: 1;
      margin-bottom: 0;
    }
    
    button {
      padding: 8px 15px;
      background-color: #4CAF50;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
      font-size: 14px;
    }
    
    button:hover {
      background-color: #45a049;
    }
    
    button.secondary {
      background-color: #666;
    }
    
    button.secondary:hover {
      background-color: #555;
    }
    
    .radio-group {
      margin-bottom: 15px;
    }
    
    .radio-group label {
      display: inline;
      font-weight: normal;
      margin-left: 5px;
      margin-right: 15px;
    }
    
    input[type="radio"] {
      margin-right: 5px;
    }
    
    input[type="checkbox"] {
      margin-right: 8px;
    }
    
    .checkbox-label {
      display: inline;
      font-weight: normal;
    }
    
    select {
      width: 100%;
      height: 200px;
      padding: 5px;
      border: 1px solid #ddd;
      border-radius: 3px;
    }
    
    .button-group {
      margin-top: 20px;
      text-align: right;
    }
    
    .button-group button {
      margin-left: 10px;
    }
    
    .info {
      color: #666;
      font-size: 12px;
      margin-top: 5px;
      font-style: italic;
    }
    
    .hidden {
      display: none;
    }
  </style>
</head>
<body>
  <div class="section">
    <h2>Export Path</h2>
    <label for="exportPath">Select folder for exported playlists:</label>
    <div class="path-input-group">
      <input type="text" id="exportPath" placeholder="C:\Music\Playlists" />
      <button onclick="selectFolder()" class="secondary">Browse...</button>
    </div>
    <div class="info">M3U files will be saved to this folder</div>
  </div>
  
  <div class="section">
    <h2>Path Format</h2>
    <label>Choose path format for tracks in M3U files:</label>
    <div class="radio-group">
      <input type="radio" id="forwardSlash" name="pathFormat" value="forward" checked />
      <label for="forwardSlash" class="checkbox-label">Forward slashes (/) - Linux-style</label><br/>
      <input type="radio" id="backSlash" name="pathFormat" value="back" />
      <label for="backSlash" class="checkbox-label">Back slashes (\) - Windows-style</label>
    </div>
    <div class="info">Example: C:/Music/song.mp3 vs C:\Music\song.mp3</div>
  </div>
  
  <div class="section">
    <h2>Playlist Selection</h2>
    <div>
      <input type="checkbox" id="exportAll" onclick="togglePlaylistSelection()" checked />
      <label for="exportAll" class="checkbox-label">Export All Playlists</label>
    </div>
    <div id="playlistSelection" class="hidden">
      <label for="playlists">Select playlists to export:</label>
      <select id="playlists" multiple>
        <!-- Playlists will be loaded dynamically -->
      </select>
      <div class="info">Hold Ctrl (Cmd on Mac) to select multiple playlists</div>
    </div>
  </div>
  
  <div class="button-group">
    <button onclick="saveSettings()">Save Configuration</button>
    <button onclick="exportNow()" class="secondary">Export Now</button>
  </div>
  
  <script>
    // Load configuration when page opens
    function loadConfig() {
      try {
        // Get current configuration
        var exportPath = app.getValue('exportPath', '');
        var exportAll = app.getValue('exportAllPlaylists', true);
        var useForwardSlash = app.getValue('useForwardSlash', true);
        var selectedPlaylists = app.getValue('exportSelectedPlaylists', '');
        
        // Set UI values
        document.getElementById('exportPath').value = exportPath;
        document.getElementById('exportAll').checked = exportAll;
        
        if (useForwardSlash) {
          document.getElementById('forwardSlash').checked = true;
        } else {
          document.getElementById('backSlash').checked = true;
        }
        
        // Load playlists
        loadPlaylists(selectedPlaylists);
        
        // Show/hide playlist selection based on exportAll
        togglePlaylistSelection();
      } catch (e) {
        if (typeof console !== 'undefined' && console.error) {
          console.error('Error loading config:', e);
        }
      }
    }
    
    // Load playlists from database
    function loadPlaylists(selectedIds) {
      try {
        var playlistSelect = document.getElementById('playlists');
        playlistSelect.innerHTML = '';
        
        // Get all playlists from database
        var sql = "SELECT IDPlaylist, PlaylistName FROM Playlists WHERE PlaylistName IS NOT NULL AND PlaylistName != '' ORDER BY PlaylistName";
        var dbConnection = app.getDb();
        var stmt = dbConnection.prepare(sql);
        
        var selectedArray = selectedIds ? selectedIds.split(',') : [];
        
        while (stmt.step()) {
          var id = stmt.getValue(0);
          var name = stmt.getValue(1);
          
          var option = document.createElement('option');
          option.value = id;
          option.textContent = name;
          
          // Check if this playlist should be selected
          for (var i = 0; i < selectedArray.length; i++) {
            if (id.toString() === selectedArray[i].trim()) {
              option.selected = true;
              break;
            }
          }
          
          playlistSelect.appendChild(option);
        }
        
        stmt.finalize();
      } catch (e) {
        if (typeof console !== 'undefined' && console.error) {
          console.error('Error loading playlists:', e);
        }
      }
    }
    
    // Toggle playlist selection visibility
    function togglePlaylistSelection() {
      var exportAll = document.getElementById('exportAll').checked;
      var playlistSelection = document.getElementById('playlistSelection');
      
      if (exportAll) {
        playlistSelection.classList.add('hidden');
      } else {
        playlistSelection.classList.remove('hidden');
      }
    }
    
    // Browse for folder
    function selectFolder() {
      try {
        var shell = new ActiveXObject("Shell.Application");
        var folder = shell.BrowseForFolder(0, "Select folder for exported playlists:", 0);
        
        if (folder) {
          var folderPath = folder.Self.Path;
          document.getElementById('exportPath').value = folderPath;
        }
      } catch (e) {
        alert('Error selecting folder: ' + e.message);
      }
    }
    
    // Save settings
    function saveSettings(silent) {
      try {
        var exportPath = document.getElementById('exportPath').value;
        var exportAll = document.getElementById('exportAll').checked;
        var useForwardSlash = document.getElementById('forwardSlash').checked;
        
        // Get selected playlists
        var selectedPlaylists = '';
        if (!exportAll) {
          var playlistSelect = document.getElementById('playlists');
          var selectedOptions = [];
          for (var i = 0; i < playlistSelect.options.length; i++) {
            if (playlistSelect.options[i].selected) {
              selectedOptions.push(playlistSelect.options[i].value);
            }
          }
          selectedPlaylists = selectedOptions.join(',');
        }
        
        // Validate export path
        if (!exportPath) {
          alert('Please select an export path');
          return false;
        }
        
        // Check if path exists
        var fso = new ActiveXObject("Scripting.FileSystemObject");
        if (!fso.FolderExists(exportPath)) {
          if (!confirm('The selected path does not exist. Do you want to continue anyway?')) {
            return false;
          }
        }
        
        // Validate playlist selection
        if (!exportAll && !selectedPlaylists) {
          alert('Please select at least one playlist or check "Export All Playlists"');
          return false;
        }
        
        // Save configuration
        app.setValue('exportPath', exportPath);
        app.setValue('exportAllPlaylists', exportAll);
        app.setValue('useForwardSlash', useForwardSlash);
        app.setValue('exportSelectedPlaylists', selectedPlaylists);
        
        if (!silent) {
          alert('Configuration saved successfully!');
        }
        return true;
      } catch (e) {
        alert('Error saving configuration: ' + e.message);
        return false;
      }
    }
    
    // Export now
    function exportNow() {
      try {
        // Save settings first (silently)
        if (!saveSettings(true)) {
          // If saveSettings returns false, validation failed
          return;
        }
        
        // Execute export action
        if (app.actions && app.actions.exportPlaylists) {
          app.actions.exportPlaylists.execute();
        } else {
          alert('Export function not available. Please restart MediaMonkey.');
        }
      } catch (e) {
        alert('Error exporting playlists: ' + e.message);
      }
    }
    
    // Load config when page loads
    window.onload = loadConfig;
  </script>
</body>
</html>
